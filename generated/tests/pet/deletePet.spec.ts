import { test, expect } from '@playwright/test';
import axios from 'axios';

// Коды статусов
const apiErrorCodes = {
  success: 200,
  created: 201,
  badRequest: 400,
  unauthorized: 401,
  forbidden: 403,
  notFound: 404,
  methodNotAllowed: 405,
  unsupportedMediaType: 415,
  unprocessableEntity: 422,
};

const endpoint = '/pet/{petId}';
const httpMethod = 'DELETE';

const unauthorized = apiErrorCodes.unauthorized;
const badRequest = apiErrorCodes.badRequest;
const forbidden = apiErrorCodes.forbidden;
const notFound = apiErrorCodes.notFound;
const methodNotAllowed = apiErrorCodes.methodNotAllowed;
const unsupportedMediaType = apiErrorCodes.unsupportedMediaType;
const success = apiErrorCodes.success;

// Конфигурация headers
const configHeaders = {
  headers: {
    'Authorization': `Bearer ${process.env.AUTH_TOKEN}`,
    'Content-Type': 'application/json',
  }
};

const configHeadersNoRights = {
  headers: {
    'Authorization': 'Bearer restricted_token_here', // TODO: заменить на токен без прав
    'Content-Type': 'application/json',
  }
};

// Информация о тест-кейсе
const caseInfoObj = {
  testCase: 'T3995',
  aqaOwner: 'AutoGenerated',
  tms_testName: 'DELETE /pet/{petId}',
  testType: 'api'
};

/**
 * Проверки:
 * - Без токена (401)
 * - Проверка methodNotAllowed для неподдерживаемых HTTP методов
 * - С неверными заголовками Content-Type (415)
 * - С несуществующим ID (404)
 * 
 * Дополнительные проверки:
 * - Проверка структуры ответа
 * - Проверка всех полей response
 */

test.describe.configure({ mode: "parallel" });
test.describe(`API тесты для эндпоинта ${httpMethod} >> ${endpoint}`, async () => {

  // Функция для построения URL
  function buildUrl(params: any = {}) {
    let url = process.env.STAND_URL + endpoint;
    // Подставляем path параметры
    url = url.replace('{petId}', params.petId || '1');
    return url;
  }

  test(`${httpMethod} без TOKEN (${unauthorized}) @api`, async ({ page }, testInfo) => {
    await axios.delete(buildUrl({ petId: 1 })).catch(async function(error) {
      await expect(error.response.status).toBe(unauthorized);
      await expect(error.response.statusText).toBe("Unauthorized");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('delete');
      await expect(error.config.url).toContain(endpoint);
    });
  });

  test(`GET с токеном (${methodNotAllowed}) @api`, async ({ page }, testInfo) => {
    await axios.get(buildUrl({ petId: 1 }), configHeaders).catch(async function(error) {
      await expect(error.response.status).toBe(methodNotAllowed);
      await expect(error.response.statusText).toBe("Method Not Allowed");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('get');
      await expect(error.config.url).toContain(endpoint);
    });
  });

  test(`POST с токеном (${methodNotAllowed}) @api`, async ({ page }, testInfo) => {
    await axios.post(buildUrl({ petId: 1 }), {}, configHeaders).catch(async function(error) {
      await expect(error.response.status).toBe(methodNotAllowed);
      await expect(error.response.statusText).toBe("Method Not Allowed");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('post');
      await expect(error.config.url).toContain(endpoint);
    });
  });

  test(`PUT с токеном (${methodNotAllowed}) @api`, async ({ page }, testInfo) => {
    await axios.put(buildUrl({ petId: 1 }), {}, configHeaders).catch(async function(error) {
      await expect(error.response.status).toBe(methodNotAllowed);
      await expect(error.response.statusText).toBe("Method Not Allowed");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('put');
      await expect(error.config.url).toContain(endpoint);
    });
  });

  test(`${httpMethod} с несуществующим ID (${notFound}) @api`, async ({ page }, testInfo) => {
    await axios.delete(buildUrl({ petId: 999999999 }), configHeaders).catch(async function(error) {
      await expect(error.response.status).toBe(notFound);
      await expect(error.response.statusText).toBe("Not Found");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
    });
  });

  test(`${httpMethod} успешный запрос (${success}) @api`, async ({ page }, testInfo) => {
    // TODO: Подготовить валидные тестовые данные
    const response = await axios.delete(buildUrl({ petId: 1 }), configHeaders);

    // Проверки статуса
    await expect(response.status).toBe(success);
    await expect(response.data).toBeDefined();

    // TODO: Добавить проверки структуры response
    // TODO: Добавить проверки обязательных полей
    // TODO: Добавить проверки типов данных
  });

});
