import test, { expect } from '../../../fixtures/baseTest';
import axios from 'axios';
import { configApiHeaderAdmin, configApiHeaderNoRights } from '../../../helpers/axiosHelpers';

const endpoint = '/pet';
const httpMethod = 'POST';

// Коды статусов
const apiErrorCodes = {
  success: 200,
  created: 201,
  badRequest: 400,
  unauthorized: 401,
  forbidden: 403,
  notFound: 404,
  methodNotAllowed: 405,
  unsupportedMediaType: 415,
};

const unauthorized = apiErrorCodes.unauthorized;
const badRequest = apiErrorCodes.badRequest;
const forbidden = apiErrorCodes.forbidden;
const notFound = apiErrorCodes.notFound;
const methodNotAllowed = apiErrorCodes.methodNotAllowed;
const unsupportedMediaType = apiErrorCodes.unsupportedMediaType;
const success = apiErrorCodes.created;

// Информация о тест-кейсе
const caseInfoObj = {
  testCase: 'T909',
  aqaOwner: 'AutoGenerated',
  tms_testName: 'POST /pet',
  testType: 'api'
};

/**
 * Проверки:
 * - Без токена (401)
 * - С токеном но без Body (400)
 * - Проверка methodNotAllowed для неподдерживаемых HTTP методов
 * - С неверными заголовками Content-Type (415)
 */

test.describe.configure({ mode: "parallel" });
test.describe(`API тесты для эндпоинта ${httpMethod} >> ${endpoint}`, async () => {

  test(`${httpMethod} без TOKEN (${unauthorized}) @api`, async ({ page }, testInfo) => {
    await axios.post(process.env.StandURL + endpoint, { /* TODO: заполнить тестовыми данными */ }).catch(async function(error) {
      await expect(error.response.status).toBe(unauthorized);
      await expect(error.response.statusText).toBe("Unauthorized");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('post');
      await expect(error.config.url).toContain(endpoint);
    });
  });

  test(`${httpMethod} с токеном без Body (${badRequest}) @api`, async ({ page }, testInfo) => {
    await axios.post(process.env.StandURL + endpoint, {}, configApiHeaderAdmin).catch(async function(error) {
      await expect(error.response.status).toBe(badRequest);
      await expect(error.response.statusText).toBe("Bad Request");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('post');
    });
  });

  test(`GET с токеном (${methodNotAllowed}) @api`, async ({ page }, testInfo) => {
    await axios.get(process.env.StandURL + endpoint, configApiHeaderAdmin).catch(async function(error) {
      await expect(error.response.status).toBe(methodNotAllowed);
      await expect(error.response.statusText).toBe("Method Not Allowed");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('get');
    });
  });

  test(`PUT с токеном (${methodNotAllowed}) @api`, async ({ page }, testInfo) => {
    await axios.put(process.env.StandURL + endpoint, {}, configApiHeaderAdmin).catch(async function(error) {
      await expect(error.response.status).toBe(methodNotAllowed);
      await expect(error.response.statusText).toBe("Method Not Allowed");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('put');
    });
  });

  test(`DELETE с токеном (${methodNotAllowed}) @api`, async ({ page }, testInfo) => {
    await axios.delete(process.env.StandURL + endpoint, configApiHeaderAdmin).catch(async function(error) {
      await expect(error.response.status).toBe(methodNotAllowed);
      await expect(error.response.statusText).toBe("Method Not Allowed");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('delete');
    });
  });

  test(`${httpMethod} с неверным Content-Type (${unsupportedMediaType}) @api`, async ({ page }, testInfo) => {
    const wrongHeaders = {
      headers: {
        'Authorization': `Bearer ${process.env.AUTH_TOKEN}`,
        'Content-Type': 'application/xml',
      }
    };
    await axios.post(process.env.StandURL + endpoint, { /* TODO: заполнить тестовыми данными */ }, wrongHeaders).catch(async function(error) {
      await expect(error.response.status).toBe(unsupportedMediaType);
      await expect(error.response.statusText).toContain("Unsupported Media Type");
    });
  });


  // ============================================
  // ПОЗИТИВНЫЕ ТЕСТЫ
  // ============================================

  // Тестовые данные для позитивных тестов

  // Объект с только обязательными полями
  const requiredFieldsOnly = {
    name: 'Test Name', // TODO: заменить на актуальные данные
    photoUrls: ['https://example.com'] // TODO: заменить на актуальные данные
  };

  // Объект со всеми полями
  const allFieldsFilled = {
    id: 1, // TODO: заменить на актуальные данные
    category: null, // TODO: заменить на актуальные данные
    name: 'Test Name', // TODO: заменить на актуальные данные
    photoUrls: ['https://example.com'], // TODO: заменить на актуальные данные
    tags: [], // TODO: заменить на актуальные данные
    status: 'available' // TODO: заменить на актуальные данные
  };

  test(`${httpMethod} с обязательными полями (${success}) @api @positive`, async ({ page }, testInfo) => {
    const response = await axios.post(process.env.StandURL + endpoint, requiredFieldsOnly, configApiHeaderAdmin);

    await expect(response.status).toBe(success);
    await expect(response.data).toBeDefined();
    // TODO: Добавить проверки обязательных полей в response
  });

  test(`${httpMethod} со всеми полями (${success}) @api @positive`, async ({ page }, testInfo) => {
    const response = await axios.post(process.env.StandURL + endpoint, allFieldsFilled, configApiHeaderAdmin);

    await expect(response.status).toBe(success);
    await expect(response.data).toBeDefined();
    // TODO: Добавить проверки всех полей в response
  });


  // ============================================
  // PAIRWISE ТЕСТЫ
  // ============================================

  // Тестовые данные для pairwise тестов

  // Комбинация 1: обязательные поля + id
  const pairwiseCombo1 = {
    name: 'Test Name',
    photoUrls: ['https://example.com'],
    id: 1
  };

  // Комбинация 2: обязательные поля + id, category
  const pairwiseCombo2 = {
    name: 'Test Name',
    photoUrls: ['https://example.com'],
    id: 1,
    category: null
  };

  // Комбинация 3: обязательные поля + id, category, tags
  const pairwiseCombo3 = {
    name: 'Test Name',
    photoUrls: ['https://example.com'],
    id: 1,
    category: null,
    tags: []
  };

  // Комбинация 4: обязательные поля + id, category
  const pairwiseCombo4 = {
    name: 'Test Name',
    photoUrls: ['https://example.com'],
    id: 1,
    category: null
  };

  // Тест с status = 'available'
  const pairwiseEnum_status_1 = {
    name: 'Test Name',
    photoUrls: ['https://example.com'],
    status: 'available'
  };

  // Тест с status = 'pending'
  const pairwiseEnum_status_2 = {
    name: 'Test Name',
    photoUrls: ['https://example.com'],
    status: 'pending'
  };

  // Тест с status = 'sold'
  const pairwiseEnum_status_3 = {
    name: 'Test Name',
    photoUrls: ['https://example.com'],
    status: 'sold'
  };


  // Тип 1: Комбинации необязательных полей

  test(`${httpMethod} pairwise комбинация 1 (${success}) @api @pairwise`, async ({ page }, testInfo) => {
    const response = await axios.post(process.env.StandURL + endpoint, pairwiseCombo1, configApiHeaderAdmin);

    await expect(response.status).toBe(success);
    await expect(response.data).toBeDefined();
  });

  test(`${httpMethod} pairwise комбинация 2 (${success}) @api @pairwise`, async ({ page }, testInfo) => {
    const response = await axios.post(process.env.StandURL + endpoint, pairwiseCombo2, configApiHeaderAdmin);

    await expect(response.status).toBe(success);
    await expect(response.data).toBeDefined();
  });

  test(`${httpMethod} pairwise комбинация 3 (${success}) @api @pairwise`, async ({ page }, testInfo) => {
    const response = await axios.post(process.env.StandURL + endpoint, pairwiseCombo3, configApiHeaderAdmin);

    await expect(response.status).toBe(success);
    await expect(response.data).toBeDefined();
  });

  test(`${httpMethod} pairwise комбинация 4 (${success}) @api @pairwise`, async ({ page }, testInfo) => {
    const response = await axios.post(process.env.StandURL + endpoint, pairwiseCombo4, configApiHeaderAdmin);

    await expect(response.status).toBe(success);
    await expect(response.data).toBeDefined();
  });

  // Тип 2: Различные значения enum полей

  test(`${httpMethod} с status='available' (${success}) @api @pairwise`, async ({ page }, testInfo) => {
    const response = await axios.post(process.env.StandURL + endpoint, pairwiseEnum_status_1, configApiHeaderAdmin);

    await expect(response.status).toBe(success);
    await expect(response.data).toBeDefined();
  });

  test(`${httpMethod} с status='pending' (${success}) @api @pairwise`, async ({ page }, testInfo) => {
    const response = await axios.post(process.env.StandURL + endpoint, pairwiseEnum_status_2, configApiHeaderAdmin);

    await expect(response.status).toBe(success);
    await expect(response.data).toBeDefined();
  });

  test(`${httpMethod} с status='sold' (${success}) @api @pairwise`, async ({ page }, testInfo) => {
    const response = await axios.post(process.env.StandURL + endpoint, pairwiseEnum_status_3, configApiHeaderAdmin);

    await expect(response.status).toBe(success);
    await expect(response.data).toBeDefined();
  });

});
