// Jenkins Pipeline - –ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è —Å Node.js —Å–∫—Ä–∏–ø—Ç–æ–º

pipeline {
    agent any
    
    parameters {
        string(
            name: 'PREV_COMPARE_VERSION', 
            defaultValue: 'FALSE', 
            description: '–í–µ—Ä—Å–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1.55.0) –∏–ª–∏ FALSE –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞'
        )
    }
    
    environment {
        NPM_REGISTRY_URL = 'https://customRegistry.niu.ru/repo/npm/api-codegen'
        PACKAGE_NAME = 'api-codegen'
    }
    
    stages {
        stage('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞') {
            steps {
                echo 'üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ —Å–±–æ—Ä–∫–∞'
                sh 'npm install'
                sh 'npm run build'
            }
        }
        
        stage('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤') {
            when {
                expression { 
                    params.PREV_COMPARE_VERSION != 'FALSE' && 
                    params.PREV_COMPARE_VERSION != '' 
                }
            }
            steps {
                echo "‚úèÔ∏è –î–æ–±–∞–≤–ª—è—é prevPackage –≤ –∫–æ–Ω—Ñ–∏–≥–∏ –¥–ª—è –≤–µ—Ä—Å–∏–∏ ${params.PREV_COMPARE_VERSION}"
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥–∏ —á–µ—Ä–µ–∑ Node.js —Å–∫—Ä–∏–ø—Ç
                sh """
                    node scripts/update-config.js configs/orders_config.json ${params.PREV_COMPARE_VERSION}
                    node scripts/update-config.js configs/products_config.json ${params.PREV_COMPARE_VERSION}
                    node scripts/update-config.js configs/finance_config.json ${params.PREV_COMPARE_VERSION}
                """
                
                echo '‚úÖ –ö–æ–Ω—Ñ–∏–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã'
            }
        }
        
        stage('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Orders') {
            steps {
                echo 'üì¶ –ì–µ–Ω–µ—Ä–∏—Ä—É—é Orders API'
                sh 'npm run generate -- --config=configs/orders_config.json'
            }
        }
        
        stage('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Products') {
            steps {
                echo 'üì¶ –ì–µ–Ω–µ—Ä–∏—Ä—É—é Products API'
                sh 'npm run generate -- --config=configs/products_config.json'
            }
        }
        
        stage('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Finance') {
            steps {
                echo 'üì¶ –ì–µ–Ω–µ—Ä–∏—Ä—É—é Finance API'
                sh 'npm run generate -- --config=configs/finance_config.json'
            }
        }
        
        stage('–ü—Ä–æ–≤–µ—Ä–∫–∞ README') {
            steps {
                echo 'üìÑ –ü—Ä–æ–≤–µ—Ä—è—é —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ README'
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ API_README.md —Å–æ–∑–¥–∞–Ω—ã
                sh '''
                    if [ -f "dist/orders/API_README.md" ]; then
                        echo "‚úì dist/orders/API_README.md —Å–æ–∑–¥–∞–Ω"
                    fi
                    
                    if [ -f "dist/products/API_README.md" ]; then
                        echo "‚úì dist/products/API_README.md —Å–æ–∑–¥–∞–Ω"
                    fi
                    
                    if [ -f "dist/finance/API_README.md" ]; then
                        echo "‚úì dist/finance/API_README.md —Å–æ–∑–¥–∞–Ω"
                    fi
                '''
            }
        }
        
        stage('–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–æ–≤') {
            when {
                expression { 
                    params.PREV_COMPARE_VERSION != 'FALSE' && 
                    params.PREV_COMPARE_VERSION != '' 
                }
            }
            steps {
                echo 'üìÑ –ê—Ä—Ö–∏–≤–∏—Ä—É—é –æ—Ç—á—ë—Ç—ã –æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏'
                
                // –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º CompareReadme –∏–∑ –∫–æ—Ä–Ω—è
                archiveArtifacts artifacts: '*CompareReadme.md', allowEmptyArchive: true
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ
                sh '''
                    echo "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç—ã:"
                    ls -lh *CompareReadme.md 2>/dev/null || echo "–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è"
                '''
            }
        }
        
        stage('–ü—É–±–ª–∏–∫–∞—Ü–∏—è') {
            steps {
                echo 'üöÄ –ü—É–±–ª–∏–∫—É—é NPM –ø–∞–∫–µ—Ç'
                
                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é
                // sh 'npm version patch'
                
                sh 'npm publish'
                
                echo '‚úÖ –ü–∞–∫–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω'
            }
        }
    }
    
    post {
        always {
            echo 'üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤'
            sh 'rm -rf .temp-comparison || true'
        }
        
        success {
            echo '‚úÖ Pipeline —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!'
            
            script {
                if (params.PREV_COMPARE_VERSION != 'FALSE' && params.PREV_COMPARE_VERSION != '') {
                    echo "üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —Å –≤–µ—Ä—Å–∏–µ–π ${params.PREV_COMPARE_VERSION}"
                    echo "üìÑ –û—Ç—á—ë—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö –±–∏–ª–¥–∞"
                }
            }
        }
        
        failure {
            echo '‚ùå Pipeline –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π'
        }
    }
}
