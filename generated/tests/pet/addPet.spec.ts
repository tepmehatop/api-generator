import { test, expect } from '@playwright/test';
import axios from 'axios';

// Коды статусов
const apiErrorCodes = {
  success: 200,
  created: 201,
  badRequest: 400,
  unauthorized: 401,
  forbidden: 403,
  notFound: 404,
  methodNotAllowed: 405,
  unsupportedMediaType: 415,
  unprocessableEntity: 422,
};

const endpoint = '/pet';
const httpMethod = 'POST';

const unauthorized = apiErrorCodes.unauthorized;
const badRequest = apiErrorCodes.badRequest;
const forbidden = apiErrorCodes.forbidden;
const notFound = apiErrorCodes.notFound;
const methodNotAllowed = apiErrorCodes.methodNotAllowed;
const unsupportedMediaType = apiErrorCodes.unsupportedMediaType;
const success = apiErrorCodes.created;

// Конфигурация headers
const configHeaders = {
  headers: {
    'Authorization': `Bearer ${process.env.AUTH_TOKEN}`,
    'Content-Type': 'application/json',
  }
};

const configHeadersNoRights = {
  headers: {
    'Authorization': 'Bearer restricted_token_here', // TODO: заменить на токен без прав
    'Content-Type': 'application/json',
  }
};

// Информация о тест-кейсе
const caseInfoObj = {
  testCase: 'T1379',
  aqaOwner: 'AutoGenerated',
  tms_testName: 'POST /pet',
  testType: 'api'
};

/**
 * Проверки:
 * - Без токена (401)
 * - С токеном но без Body (400)
 * - Без указания обязательных полей (400)
 * - Проверка methodNotAllowed для неподдерживаемых HTTP методов
 * - С неверными заголовками Content-Type (415)
 * 
 * Дополнительные проверки:
 * - Проверка структуры ответа
 * - Проверка всех полей response
 */

test.describe.configure({ mode: "parallel" });
test.describe(`API тесты для эндпоинта ${httpMethod} >> ${endpoint}`, async () => {

  // Функция для построения URL
  function buildUrl(params: any = {}) {
    let url = process.env.STAND_URL + endpoint;
    return url;
  }

  test(`${httpMethod} без TOKEN (${unauthorized}) @api`, async ({ page }, testInfo) => {
    await axios.post(buildUrl(), {}).catch(async function(error) {
      await expect(error.response.status).toBe(unauthorized);
      await expect(error.response.statusText).toBe("Unauthorized");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('post');
      await expect(error.config.url).toContain(endpoint);
    });
  });

  test(`${httpMethod} с токеном без Body (${badRequest}) @api`, async ({ page }, testInfo) => {
    await axios.post(buildUrl(), {}, configHeaders).catch(async function(error) {
      await expect(error.response.status).toBe(badRequest);
      await expect(error.response.statusText).toBe("Bad Request");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('post');
      await expect(error.config.url).toContain(endpoint);
    });
  });

  test(`GET с токеном (${methodNotAllowed}) @api`, async ({ page }, testInfo) => {
    await axios.get(buildUrl(), configHeaders).catch(async function(error) {
      await expect(error.response.status).toBe(methodNotAllowed);
      await expect(error.response.statusText).toBe("Method Not Allowed");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('get');
      await expect(error.config.url).toContain(endpoint);
    });
  });

  test(`PUT с токеном (${methodNotAllowed}) @api`, async ({ page }, testInfo) => {
    await axios.put(buildUrl(), {}, configHeaders).catch(async function(error) {
      await expect(error.response.status).toBe(methodNotAllowed);
      await expect(error.response.statusText).toBe("Method Not Allowed");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('put');
      await expect(error.config.url).toContain(endpoint);
    });
  });

  test(`DELETE с токеном (${methodNotAllowed}) @api`, async ({ page }, testInfo) => {
    await axios.delete(buildUrl(), configHeaders).catch(async function(error) {
      await expect(error.response.status).toBe(methodNotAllowed);
      await expect(error.response.statusText).toBe("Method Not Allowed");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('delete');
      await expect(error.config.url).toContain(endpoint);
    });
  });

  test(`${httpMethod} с неверным Content-Type (${unsupportedMediaType}) @api`, async ({ page }, testInfo) => {
    const wrongHeaders = {
      headers: {
        'Authorization': `Bearer ${process.env.AUTH_TOKEN}`,
        'Content-Type': 'application/xml',
      }
    };
    await axios.post(buildUrl(), { /* TODO: заполнить тестовыми данными */ }, wrongHeaders).catch(async function(error) {
      await expect(error.response.status).toBe(unsupportedMediaType);
      await expect(error.response.statusText).toContain("Unsupported Media Type");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
    });
  });

  test(`${httpMethod} успешный запрос (${success}) @api`, async ({ page }, testInfo) => {
    // TODO: Подготовить валидные тестовые данные
    const response = await axios.post(buildUrl(), { /* TODO: заполнить тестовыми данными */ }, configHeaders);

    // Проверки статуса
    await expect(response.status).toBe(success);
    await expect(response.data).toBeDefined();

    // TODO: Добавить проверки структуры response
    // TODO: Добавить проверки обязательных полей
    // TODO: Добавить проверки типов данных
  });

});
