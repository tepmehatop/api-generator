import test, { expect } from '../../../fixtures/baseTest';
import axios from 'axios';
import { configApiHeaderAdmin, configApiHeaderNoRights } from '../../../helpers/axiosHelpers';

// ID параметры для endpoint
const petId = 1; // TODO: заменить на актуальный ID

const endpoint = `/pet/${petId}`;
const httpMethod = 'GET';

// Коды статусов
const apiErrorCodes = {
  success: 200,
  created: 201,
  badRequest: 400,
  unauthorized: 401,
  forbidden: 403,
  notFound: 404,
  methodNotAllowed: 405,
  unsupportedMediaType: 415,
};

const unauthorized = apiErrorCodes.unauthorized;
const badRequest = apiErrorCodes.badRequest;
const forbidden = apiErrorCodes.forbidden;
const notFound = apiErrorCodes.notFound;
const methodNotAllowed = apiErrorCodes.methodNotAllowed;
const unsupportedMediaType = apiErrorCodes.unsupportedMediaType;
const success = apiErrorCodes.success;

// Информация о тест-кейсе
const caseInfoObj = {
  testCase: 'T5827',
  aqaOwner: 'AutoGenerated',
  tms_testName: 'GET /pet/{petId}',
  testType: 'api'
};

/**
 * Проверки:
 * - Без токена (401)
 * - Проверка methodNotAllowed для неподдерживаемых HTTP методов
 * - С неверными заголовками Content-Type (415)
 * - С несуществующим ID (404)
 */

test.describe.configure({ mode: "parallel" });
test.describe(`API тесты для эндпоинта ${httpMethod} >> ${endpoint}`, async () => {

  test(`${httpMethod} без TOKEN (${unauthorized}) @api`, async ({ page }, testInfo) => {
    await axios.get(process.env.StandURL + endpoint).catch(async function(error) {
      await expect(error.response.status).toBe(unauthorized);
      await expect(error.response.statusText).toBe("Unauthorized");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('get');
      await expect(error.config.url).toContain(endpoint);
    });
  });

  test(`POST с токеном (${methodNotAllowed}) @api`, async ({ page }, testInfo) => {
    await axios.post(process.env.StandURL + endpoint, {}, configApiHeaderAdmin).catch(async function(error) {
      await expect(error.response.status).toBe(methodNotAllowed);
      await expect(error.response.statusText).toBe("Method Not Allowed");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('post');
    });
  });

  test(`PUT с токеном (${methodNotAllowed}) @api`, async ({ page }, testInfo) => {
    await axios.put(process.env.StandURL + endpoint, {}, configApiHeaderAdmin).catch(async function(error) {
      await expect(error.response.status).toBe(methodNotAllowed);
      await expect(error.response.statusText).toBe("Method Not Allowed");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('put');
    });
  });

  test(`DELETE с токеном (${methodNotAllowed}) @api`, async ({ page }, testInfo) => {
    await axios.delete(process.env.StandURL + endpoint, configApiHeaderAdmin).catch(async function(error) {
      await expect(error.response.status).toBe(methodNotAllowed);
      await expect(error.response.statusText).toBe("Method Not Allowed");
      await expect(error.code).toBe("ERR_BAD_REQUEST");
      await expect(error.config.method).toBe('delete');
    });
  });

  test(`${httpMethod} с несуществующим ID (${notFound}) @api`, async ({ page }, testInfo) => {
    const petIdNotFound = 999999999;
    const endpoint404 = `/pet/${petIdNotFound}`;
    await axios.get(process.env.StandURL + endpoint404, configApiHeaderAdmin).catch(async function(error) {
      await expect(error.response.status).toBe(notFound);
      await expect(error.response.statusText).toBe("Not Found");
    });
  });


  // ============================================
  // ПОЗИТИВНЫЕ ТЕСТЫ
  // ============================================

  test(`${httpMethod} успешный запрос (${success}) @api @positive`, async ({ page }, testInfo) => {
    const response = await axios.get(process.env.StandURL + endpoint, configApiHeaderAdmin);

    await expect(response.status).toBe(success);
    await expect(response.data).toBeDefined();
  });

});
